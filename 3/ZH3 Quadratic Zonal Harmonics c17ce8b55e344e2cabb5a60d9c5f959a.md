# ZH3: Quadratic Zonal Harmonics

[https://torust.me/ZH3.pdf](https://torust.me/ZH3.pdf)

- 2024

![제작 맵에서 선형 SH(왼쪽), 예측된 ZH3(가운데, 우리의 기여), 이차 SH(오른쪽)의 간접 확산 조명입니다. 선형 SH는 저장 공간을 최소화하지만, 시각적으로 중요한 문제가 있을 수 있습니다. 이 예시에서 선형 SH는 난간 아래와 들고 있는 칼에서 음의 로브와 색상 변화를 일으키며, 방수포에 대한 투과 조명을 정확히 표현하지 못합니다. 이차 SH는 훨씬 더 정확하지만, 샘플당 두 배 이상의 저장 공간을 요구하여 공간적으로 밀집된 데이터에는 비용이 많이 듭니다. 예측된 ZH3는 선형 SH의 문제를 해결하면서 동일한 저장 공간과 최소한의 추가 계산으로 이차 SH 참조에 훨씬 더 가까운 결과를 제공합니다.](ZH3%20Quadratic%20Zonal%20Harmonics%20c17ce8b55e344e2cabb5a60d9c5f959a/Untitled.png)

제작 맵에서 선형 SH(왼쪽), 예측된 ZH3(가운데, 우리의 기여), 이차 SH(오른쪽)의 간접 확산 조명입니다. 선형 SH는 저장 공간을 최소화하지만, 시각적으로 중요한 문제가 있을 수 있습니다. 이 예시에서 선형 SH는 난간 아래와 들고 있는 칼에서 음의 로브와 색상 변화를 일으키며, 방수포에 대한 투과 조명을 정확히 표현하지 못합니다. 이차 SH는 훨씬 더 정확하지만, 샘플당 두 배 이상의 저장 공간을 요구하여 공간적으로 밀집된 데이터에는 비용이 많이 듭니다. 예측된 ZH3는 선형 SH의 문제를 해결하면서 동일한 저장 공간과 최소한의 추가 계산으로 이차 SH 참조에 훨씬 더 가까운 결과를 제공합니다.

## **1. INTRODUCTION**

인터랙티브 애플리케이션에서는 구면 함수의 효율적이고 압축된 표현이 필요합니다. 구면 조화 함수(SH)는 방사, 조사, 전이 벡터를 표현하는 데 자주 사용되며, 낮은 저장 및 평가 비용으로 높은 재구성 품질을 제공합니다. 구면 가우시안, 웨이블렛, Ambient Dice 등의 다른 표현법도 높은 품질을 제공할 수 있지만, 일반적으로 저차 구면 조화 함수보다 저장 및 평가 비용이 더 많이 들어 저가 플랫폼, 특히 모바일 기기에서는 비실용적입니다. 가벼운 구면 방사 기저 함수도 사용되지만, 제한 사항이 존재합니다.

구면 조화 함수는 주로 선형(SH2) 또는 이차(SH3) 차수를 사용합니다. 선형 구면 조화 함수는 12개의 계수와 네 개의 기저 함수만 사용하지만 부정확할 수 있으며, 재구성된 조명이 저주파이고 음의 로브가 발생할 수 있습니다. 반면, 이차 구면 조화 함수는 27개의 계수와 아홉 개의 기저 함수를 평가해야 하지만, 조사를 정확하게 표현할 수 있습니다.

이 논문에서는 선형 SH보다 약간 더 많은 비용으로 이차 SH의 품질에 접근하는 것을 목표로 합니다. 이를 위해 구면 조화 함수의 부분집합인 졸널 조화 함수(ZH)를 고려합니다. 이전 연구에서는 졸널 조화 함수가 빠른 회전, 환경 맵의 프리필터링, 변형 가능한 전이를 표현하는 데 사용되었습니다. 우리는 조명 재구성을 위해 졸널 조화 함수를 추가하는 방법을 제안합니다. 구체적으로, 선형 SH에 이차 졸널(ZH3) 기저 함수를 추가하면 이차 SH의 많은 외관을 달성할 수 있음을 보여줍니다. 우리는 ZH3 계수를 명시적으로 해결하고 저장하는 방법을 조사하며, 선형 SH에서 ZH3 계수를 추정하여 저장하지 않고도 선형 SH보다 재구성 정확도를 향상시키는 방법을 제시합니다.

## **2. SPHERICAL HARMONICS**

구면 조화 함수(SH)는 직교 기저 함수의 일련으로 정의됩니다. 구면 조화 함수는 주어진 구형 좌표에서 정의되며, 각 기저 함수는 구형 좌표(𝜃, 𝜙)를 사용하여 계산됩니다. 이 함수들은 연관된 르장드르 다항식과 정규화 상수를 포함하여 계산되며, 특정 밴드 인덱스(𝑙)와 함수 인덱스(𝑚)로 개별 기저 함수를 식별할 수 있습니다. 특정 차수(𝑂)의 구면 조화 함수는 첫 𝑂 밴드와 𝑂^2 기저 함수로 구성되며, 각 차수는 그에 상응하는 다항식 차수로도 식별할 수 있습니다.

구면 조화 함수는 직교 기저 함수이므로, 최소 자승 인코딩은 투영으로 표현됩니다. 즉, 함수 𝑓(𝑠)를 구면 조화 함수로 근사할 때, 기저 함수의 계수는 𝑓(𝑠)와 각 기저 함수의 내적으로 계산됩니다. 재구성은 이 기저 함수 계수들의 합으로 이루어집니다. 구면 조화 함수는 회전에 대해 닫혀 있으며, 적은 밴드를 사용하여 매끄러운 함수를 정확하게 표현할 수 있습니다. 구면 좌표 형태는 상징적 계산과 해석적 적분 평가에 편리하지만, 런타임에서는 데카르트 좌표의 다항식 형태로 효율적으로 평가됩니다.

### **2.1 Zonal Harmonics**

졸널 조화 함수(ZH)는 구면 조화 함수의 부분집합으로, 각 밴드에서 졸널(𝑚 = 0) 계수만이 비제로입니다. 원형 대칭을 가진 함수는 졸널 조화 함수로 투영될 수 있으며, 모든 구면 방사 기저 함수(SRBF)는 이 축을 따라 정렬된 졸널 조화 함수로 표현될 수 있습니다. 임의의 SH 함수 𝑓와 졸널 SH 함수 ℎ는 닫힌 형태로 컨볼루션될 수 있으며, ZH 계수는 밴드별 스케일 팩터로서 컨볼루션을 계산할 때 적용됩니다.

### **2.2 Linear Spherical Harmonics (SH2)**

선형 구면 조화 함수(SH2)는 DC 항과 세 개의 주요 축에 해당하는 기저 함수들로 구성됩니다. RGB 색상에 대해 선형 SH는 12개의 계수가 필요합니다. 최적의 선형 방향에 맞추면, 선형 SH는 항상 졸널 조화 함수로 표현될 수 있습니다. 이 좌표 프레임에서, ZH 계수는 L1 밴드의 길이로 주어지며, 다른 계수들은 0이 됩니다.

### **2.3 Quadratic Spherical Harmonics (SH3)**

이차 구면 조화 함수(SH3)는 추가로 다섯 개의 기저 함수를 포함합니다. 이차 SH는 평균 오차가 3% 미만으로, 조사를 정확하게 표현할 수 있습니다. 이차 SH는 환경 조명을 압축하여 표현하는 데 자주 사용됩니다.

## **3. ZONAL QUADRATIC SPHERICAL HARMONICS (ZH3)**

이차 구면 조화 함수(SH3)로 확장하려면 색상 채널당 5개의 추가 계수가 필요하여 저장 및 평가 비용이 크게 증가합니다. 이는 특히 공간적으로 밀집된 데이터에 문제를 일으킬 수 있습니다. 이를 해결하기 위해 ZH3를 도입합니다. ZH3는 선형 SH에 선형 SH 좌표 프레임에서 표현된 이차 졸널 계수를 추가하여 선형 SH와 비교했을 때 비용을 최소화하면서 시각적 품질을 크게 개선합니다. ZH3는 ZH3 신호를 정확하게 표현할 수 있으며, 다양한 신호에서 재구성을 크게 향상시킵니다. 이차 SH와 비교했을 때, ZH3는 채널당 4개의 계수가 적게 필요하며, 비율 기반 인코딩 방식을 사용하면 저장 공간이 절반으로 줄어듭니다.

### **3.1 Solving for ZH3**

주어진 졸널 프레임에서 최소 자승 적합을 통해 이차 ZH 계수 𝑘2를 찾을 수 있습니다. 선형 구면 조화 함수에서 최적의 선형 방향을 사용하여 계산된 다섯 개의 이차 기저 함수와 대상 기저 계수 𝑓2를 사용하여 계산됩니다. 결과적으로, 이 프레임에서 SH의 𝑙0_2 계수는 이차 졸널 계수 𝑘2와 동일하게 됩니다.

![다양한 환경 맵에서 SH2, ZH3(해결된 공유 휘도 축을 사용), 곡선 맞춤 ZH3 예측, SH3의 조사 재구성 비교입니다.](ZH3%20Quadratic%20Zonal%20Harmonics%20c17ce8b55e344e2cabb5a60d9c5f959a/Untitled%201.png)

다양한 환경 맵에서 SH2, ZH3(해결된 공유 휘도 축을 사용), 곡선 맞춤 ZH3 예측, SH3의 조사 재구성 비교입니다.

### **3.2 Luminance Blend**

각 색상 채널의 졸널 축이 정렬되지 않으면 색상 변형과 같은 문제가 발생할 수 있습니다. 이러한 문제를 해결하기 위해 새로운 공유 축을 도입합니다. 이 축은 RGB SH의 가중 평균으로 계산된 조명 SH의 최적 선형 방향입니다. 새로운 축은 이차(ZH3) 항에만 사용되며, 각 채널의 L2 졸널 계수는 이 축을 따라 해결되고 평가됩니다. 이를 통해 실행 시 평가 비용을 줄이고, 축을 하나만 계산하면 되므로 오류를 줄일 수 있습니다.

### **3.3 Solving for the ZH3 Axis**

ZH3의 중요한 속성 중 하나는 졸널 축이 선형 구면 조화 함수에서 암시적으로 결정된다는 것입니다. 그러나 선형 구면 조화 함수로부터 얻은 졸널 축이 항상 최적의 오류를 제공하는 것은 아니므로, L1(선형) 및 L2(이차) 졸널 항을 모두 고려하여 최적의 재구성 오류를 제공하는 축을 해결하는 것이 종종 유리합니다. 이를 위해 BFGS 기반의 최적화 알고리즘을 사용하여 최적의 방향을 찾습니다.

![다양한 환경 맵에서 조사 재구성에 대한 RMS 오류입니다.](ZH3%20Quadratic%20Zonal%20Harmonics%20c17ce8b55e344e2cabb5a60d9c5f959a/Untitled%202.png)

다양한 환경 맵에서 조사 재구성에 대한 RMS 오류입니다.

![제작 맵의 조명 프로브에서 SH2, 공유 휘도 축이 없는 ZH3, 공유 휘도 축이 있는 ZH3, SH3의 조사 재구성입니다. 공유 휘도 축은 채널별 축 버전에서 색상 아티팩트를 해결하고, 빨간색과 녹색 채널의 오류를 줄여 SH3와 더 가까운 외관을 제공합니다.](ZH3%20Quadratic%20Zonal%20Harmonics%20c17ce8b55e344e2cabb5a60d9c5f959a/Untitled%203.png)

제작 맵의 조명 프로브에서 SH2, 공유 휘도 축이 없는 ZH3, 공유 휘도 축이 있는 ZH3, SH3의 조사 재구성입니다. 공유 휘도 축은 채널별 축 버전에서 색상 아티팩트를 해결하고, 빨간색과 녹색 채널의 오류를 줄여 SH3와 더 가까운 외관을 제공합니다.

![제작 맵의 조명 프로브에서 수정되지 않은 선형 SH 축을 사용한 SH2, 해결된 졸널 축을 사용한 ZH3, SH3의 조사 재구성입니다. 졸널 축을 해결하면 외관과 정확도가 크게 개선됩니다. L1 밴드의 기여도가 상대적으로 작기 때문에, L2 밴드 기반으로 재적합하면 매우 유익합니다.](ZH3%20Quadratic%20Zonal%20Harmonics%20c17ce8b55e344e2cabb5a60d9c5f959a/Untitled%204.png)

제작 맵의 조명 프로브에서 수정되지 않은 선형 SH 축을 사용한 SH2, 해결된 졸널 축을 사용한 ZH3, SH3의 조사 재구성입니다. 졸널 축을 해결하면 외관과 정확도가 크게 개선됩니다. L1 밴드의 기여도가 상대적으로 작기 때문에, L2 밴드 기반으로 재적합하면 매우 유익합니다.

### **3.4 Hallucinating the ZH3 Coefficient**

ZH3 계수를 저장하는 대신, 선형 구면 조화 함수로부터 이를 예측하는 방법을 사용할 수 있습니다. 이를 통해 선형 SH의 재구성 알고리즘을 수정하여 재구성 품질을 개선할 수 있습니다. 이는 선형 SH가 음의 로브, 색상 변화 등의 문제를 일으키기 때문에 필요합니다. 우리는 ZH3 계수를 예측하여 조명 신호의 첫 번째와 두 번째 모멘트를 보존하며, 실제 데이터 기반으로 이 방법이 더 나은 결과를 제공함을 보여줍니다.

![Geomerics는 조명을 과도하게 밝히는 경향이 있는 반면, ZH3 예측은 참조의 전체 색조를 더 정확하게 재구성합니다. 조명 환경은 제작 맵에서 가져온 SH3 프로브입니다.](ZH3%20Quadratic%20Zonal%20Harmonics%20c17ce8b55e344e2cabb5a60d9c5f959a/Untitled%205.png)

Geomerics는 조명을 과도하게 밝히는 경향이 있는 반면, ZH3 예측은 참조의 전체 색조를 더 정확하게 재구성합니다. 조명 환경은 제작 맵에서 가져온 SH3 프로브입니다.

![조명 계수의 L1/L0 비율(가로 축)과 ZH3 조사 계수(세로 축)입니다. 회색 점들은 일련의 제작 맵에서 가져온 실제 값이고, 곡선들은 논의된 세 가지 예측 모델입니다. 평균 ZH3 계수가 0이 아니며, 비율이 이를 추정하는 합리적인 수단임을 나타내는 명확한 전체 경향이 있습니다.](ZH3%20Quadratic%20Zonal%20Harmonics%20c17ce8b55e344e2cabb5a60d9c5f959a/Untitled%206.png)

조명 계수의 L1/L0 비율(가로 축)과 ZH3 조사 계수(세로 축)입니다. 회색 점들은 일련의 제작 맵에서 가져온 실제 값이고, 곡선들은 논의된 세 가지 예측 모델입니다. 평균 ZH3 계수가 0이 아니며, 비율이 이를 추정하는 합리적인 수단임을 나타내는 명확한 전체 경향이 있습니다.

### **3.4.1 Ambient & Directional**

가장 단순한 모델은 선형 SH를 주변광과 방향광의 결과로 간주하는 것입니다. 이때 최적의 선형 방향은 방향광의 방향으로 설정됩니다. 방향광의 비율은 주어진 비율로 계산되며, 이에 따라 ZH3 계수를 예측할 수 있습니다.

### **3.4.2 Spherical Lights**

구형 조명은 닫힌 형태의 ZH 계수로 표현될 수 있습니다. 이 계수들은 구의 반지름과 중심까지의 거리로 표현되며, 주어진 구형 좌표에서 조명의 비율을 통해 계산됩니다.

### **3.4.3 Curve Fit**

구형 영역 조명 모델이 실제 데이터에 적합하지 않으므로, 실제 조명 데이터를 기반으로 곡선을 맞추는 것이 더 좋습니다. 이를 통해 ZH3 계수를 예측할 수 있으며, 이는 선형 SH와 비교했을 때 오류를 크게 줄입니다.

### **3.4.4 Luminance Zonal Axis**

색상 간 축이 다를 때 발생할 수 있는 색상 변형 문제를 해결하기 위해 공유된 휘도 축을 사용합니다. 이 경우, 비율은 새로운 축에 투영된 L1 계수를 사용하여 계산됩니다. 이를 통해 오류를 줄이고 재구성 품질을 향상시킬 수 있습니다.

```glsl
float3 SHHallucinateZH3Irradiance(float3 sh[4], float3 direction) {
	// Use the zonal axis from the luminance SH.
	const float3 lumCoeffs = float3(0.2126f, 0.7152f, 0.0722f); // sRGB luminance.
	float3 zonalAxis = normalize(float3(−dot(sh[3], lumCoeffs), −dot(sh[1], lumCoeffs), dot(sh[2], lumCoeffs)));
	float3 ratio = 0.0;
	ratio.r = abs(dot(float3(−sh[3].r, −sh[1].r, sh[2].r), zonalAxis));
	ratio.g = abs(dot(float3(−sh[3].g, −sh[1].g, sh[2].g), zonalAxis));
	ratio.b = abs(dot(float3(−sh[3].b, −sh[1].b, sh[2].b), zonalAxis));
	ratio /= sh[0];
	float3 zonalL2Coeff = sh[0] ∗ (0.08f ∗ ratio + 0.6f ∗ ratio ∗ ratio); // Curve−fit; Section 3.4.3
	float fZ = dot(zonalAxis, direction);
	float zhDir = sqrt(5.0f / (16.0f ∗ PI)) ∗ (3.0f ∗ fZ ∗ fZ − 1.0f);
	// Convolve sh with the normalized cosine kernel (multiply the L1 band by the zonal scale 2/3), then dot with
	// SH(direction) for linear SH (Equation 5).
	float3 result = SHLinearEvaluateIrradiance(sh, direction);
	// Add irradiance from the ZH3 term. zonalL2Coeff is the ZH3 coefficient for a radiance signal, so we need to
	// multiply by 1/4 (the L2 zonal scale for a normalized clamped cosine kernel) to evaluate irradiance.
	result += 0.25f ∗ zonalL2Coeff ∗ zhDir;
	return result;
}
```

## **4. DISCUSSION**

ZH3 계수를 예측하여 조도 재구성하는 방법은 여러 상업용 비디오 게임에 도입되었습니다. 이 방법의 초기 동기는 선형 SH를 통해 반투명 표면을 통한 조명을 개선하는 것이었습니다. 현재는 채널별 졸널 축과 구형 조명 모델을 사용한 구현이 배포되었지만, 앞으로는 공유된 휘도 축과 곡선 맞춤 방법을 사용할 계획입니다. ZH3 저장 형식을 사용한 구현은 아직 배포되지 않았지만, 이를 검토 중에 있습니다. 현재는 월드 스페이스 조명 표현을 위해 완전한 이차 SH를 사용하고 있으며, 이는 각 SH 프로브가 28바이트의 메모리를 사용합니다. ZH3 저장 형식으로 전환하면 메모리 사용량을 절반으로 줄일 수 있어 모바일 플랫폼에 특히 유리합니다.

저장된 ZH3 계수와 예측된 ZH3 계수의 장단점을 비교할 때, 성능 관점에서 두 방법 간 큰 차이는 없습니다. ZH3 계수는 3바이트로 최소한의 저장 공간을 차지하며, 양자화된 계수를 디코딩하는 것과 비교할 때 예측하는 데 12개의 명령어/18 사이클이 추가로 필요합니다. 저장된 ZH3 계수는 예측된 계수보다 오류가 적으며, 테스트 세트에서 ZH3 계수는 곡선 맞춤 예측된 계수보다 27% 낮은 오류를 보였습니다. 이는 점 샘플링된 표현에서 명확한 선택이 됩니다.

보간 특성을 고려할 때 상황은 더 복잡해집니다. ZH3 계수는 선형 축에 대해 저장되며, 선형 SH 계수의 선형 보간은 ZH3 계수의 비선형 보간을 초래합니다. 비선형 모델의 계수를 보간할 때는 데이터가 조정되지 않으면 재구성 아티팩트가 발생할 수 있습니다. ZH3는 축이 천천히 변화할 때 대체로 잘 동작하지만, 희소 데이터의 경우 ZH3 보간은 이차 SH로 확장한 후 결과를 혼합해야 합니다. 이는 픽셀당 비용이 높아지거나, 저장된 이차 SH를 하드웨어에서 보간 가능한 텍스처에 저장하면 메모리와 대역폭 요구사항이 두 배로 증가합니다. 반면, 런타임에 선형 SH를 보간하고 ZH3 계수를 DC 비율로 예측하면, 이는 SH3 결과를 모방하여 선형 SH의 비율을 자연스럽게 줄입니다.

ZH3 대신 다른 조명 모델 간 혼합 계수 또는 신경망의 잠재 공간 좌표를 해결하려는 시도도 있었지만, 단순히 이차 ZH 계수를 예측하는 것은 셰이더를 단순화하면서 중요한 모멘트를 보존하는 큰 이점이 있습니다. 선형 SH를 저장하고 ZH 축을 재구성하면 적은 계수를 사용하면서 졸널 구조를 유지할 수 있습니다.

공유된 휘도 축을 사용하는 것은 색상 변형 아티팩트를 해결하고 시각적 결과를 개선합니다. 이를 사용하는 동기는 명확하지 않지만, 몇 가지 직관이 있습니다. 휘도 축을 사용할 때, 졸널 축을 색광으로 취급하여 색상 채널 간 색상 변형이 상관되도록 합니다. 또 다른 직관은 선형 축이 다를 때, ZH3 계수의 최소 자승 적합이 일반적으로 감소한다는 것입니다. 이로 인해 휘도 축에 투영하는 것이 일종의 창 효과를 나타낼 수 있습니다. 이를 더 엄밀히 조사하는 것은 흥미로운 연구 방향입니다.

## **5. CONCLUSIONS AND FUTURE WORK**

우리는 선형 SH와 이차 SH 사이의 격차를 메우는 새로운 ZH3 형식을 도입하여, 저장 공간이나 계산 비용의 최소 증가로 선형 SH보다 시각적 품질을 크게 향상시켰습니다. 우리는 ZH3를 해결하는 방법을 논의했으며, 선형 SH 매개변수를 조정하여 더 나은 졸널 축을 형성하는 방법을 설명했습니다. 또한, 공유된 휘도 축을 사용하여 색상 아티팩트를 최소화하고 시각적 결과를 개선하는 방법을 보여주었습니다. 우리는 선형 SH로부터 높은 주파수를 예측하여 ZH3를 사용함으로써 조사 재구성을 개선하는 방법을 제안했습니다. 이는 기존의 방법보다 정확성과 외관에서 모두 향상된 결과를 제공합니다.

미래 연구에서는 ZH3 보간 방법과 공유된 휘도 축의 동작에 대한 추가 탐구가 흥미로운 방향이 될 것입니다. 또한, 졸널 축에 대해 이차 구면 조화 함수 기저 함수를 사용하는 것이 최적이 아니라는 점에서 다른 기저 함수들을 조사하는 것도 가치가 있을 것입니다. 마지막으로, ZH3 계수를 예측하는 이유는 더 높은 차수의 항과 다른 기저 함수에도 적용될 수 있으며, 조사에 대한 기여도가 점점 감소하더라도 이를 더 철저히 조사하는 것이 유익할 수 있습니다.