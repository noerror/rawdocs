# Towards Ghost-free Shadow Removal via Dual Hierarchical Aggregation Network and Shadow Matting GAN

[https://github.com/vinthony/ghost-free-shadow-removal](https://github.com/vinthony/ghost-free-shadow-removal)

[https://arxiv.org/abs/1911.08718](https://arxiv.org/abs/1911.08718)

- Nov 2019

### 1 Introduction

그림자, 특히 광원 반대편에 드리워진 그림자는 물체 감지 및 추적과 같은 컴퓨터 비전 작업을 방해할 수 있습니다. 그림자를 제거하기 위한 많은 접근 방식에는 그림자 영역을 감지하고 배경과 일치하도록 변환하는 것이 포함됩니다. 최근의 딥러닝 기반 방법에는 네트워크 구조가 잘못 설계되고 학습을 위한 고품질 이미지 쌍이 부족하다는 등의 심각한 단점이 있습니다. 이 연구에서는 그림자를 효과적으로 지우고 그림자가 없는 고품질 이미지를 생성하도록 설계된 새로운 네트워크 구조를 제시합니다.

![노란색 사각형으로 표시된 입력값과 함께 모델의 결과를 표시합니다. 두 개의 확대 영역에서 그림자를 성공적으로 제거하고 유령 현상을 줄인 것을 확인할 수 있습니다.](Towards%20Ghost-free%20Shadow%20Removal%20via%20Dual%20Hierarc%20060762920b504ff8ba4d65eccee67e00/Untitled.png)

노란색 사각형으로 표시된 입력값과 함께 모델의 결과를 표시합니다. 두 개의 확대 영역에서 그림자를 성공적으로 제거하고 유령 현상을 줄인 것을 확인할 수 있습니다.

이 구조는 그림자가 있는 이미지와 그림자가 없는 이미지가 동일한 의미 정보를 공유하며 그림자 제거 작업은 그림자에만 집중하면 된다는 관찰에 기반합니다. 따라서 새로운 네트워크는 다양한 컨텍스트를 캡처하고 유용한 저수준 특징을 보존하기 위해 확장 컨볼루션을 통합한 이미지 처리 네트워크를 사용합니다. 또한 그림자 영역을 특별히 학습하도록 설계된 계층적 집계 주의 모델을 도입합니다.

또한 연구진은 합성 그림자 이미지를 생성하기 위해 자연 현상에서 영감을 얻었습니다. 연구진은 움직이는 물체가 그림자가 없는 단일 이미지에서 많은 그림자 이미지를 생성할 수 있다는 사실을 발견했습니다. 이 아이디어를 바탕으로 연구진은 생성적 적대 신경망(GAN)을 사용하여 그림자 합성 네트워크를 개발했습니다. 이 네트워크는 그림자 매팅을 먼저 학습한 다음 그림자가 없는 원본 이미지와 매팅을 사용하여 고품질의 그림자를 생성합니다.

새로운 접근 방식에는 그림자 감지의 지원을 받아 그림자를 제거하기 위한 이중 계층적 집계 네트워크(DHAN)라는 공동 학습 프레임워크가 포함됩니다. 이 네트워크는 확장된 다중 컨텍스트 특징과 주의를 계층적으로 집계합니다. 또한 연구진은 현재 페어링된 섀도 데이터 세트에 대해 섀도 매팅 GAN을 설계하고 훈련하여 추가로 페어링된 샘플을 생성했습니다. 실험 결과에 따르면 이 새로운 알고리즘은 특히 시각적 품질 측면에서 이전 방법보다 성능이 뛰어난 것으로 나타났습니다.

### 2 Related Work

그림자 제거의 초기 작업은 일반적으로 사용자 상호 작용이 필요하거나 수작업으로 만든 기능에 의존했습니다. 이후 일부 연구자들은 컨볼루션 신경망(CNN)에서 영감을 얻어 글로벌 및 로컬 컨텍스트에 기반한 그림자 제거를 위한 다중 스트림 신경망을 제안했습니다. 다른 연구자들은 방향을 인식하는 완전한 컨볼루션 네트워크 구조를 사용했습니다. 또한 스택형 생성적 적대 신경망(GAN)을 사용해 그림자 제거와 탐지를 동시에 학습하려는 연구도 있었고, 보다 강력한 네트워크와 반복 학습을 통해 이 접근 방식을 구축한 연구도 있었습니다.

그림자 합성의 경우, 대량의 그림자 제거 데이터 세트를 수집해야 하는 어려움 때문에 그래픽 툴을 사용하거나 비디오 게임의 조명을 제어하여 그림자 이미지를 생성하는 경우도 있었습니다. 그러나 이러한 인위적으로 렌더링된 장면이나 그림자는 자연스러운 장면과 크게 다릅니다. 일부 연구자들은 그림자 감지 전에 적대적인 그림자 이미지를 생성하기 위한 2단계 네트워크를 제안했습니다. 이러한 적대적 이미지는 그림자 강도를 높여 그림자를 제거하는 데도 사용되었습니다. 페어링된 데이터 세트의 한계를 인식한 일부에서는 그림자 합성을 위한 보조 네트워크를 포함하여 페어링되지 않은 그림자/그림자가 없는 이미지에서 그림자를 제거하기 위해 신경망을 훈련시키려고 시도했습니다. 그러나 합성된 그림자는 페어링된 데이터 세트에서 학습되지 않았고 그림자 생성기는 주기 일관성 손실에만 사용되었습니다.

그림자 감지를 위해 초기 방법에서는 조명과 색상의 물리적 모델을 활용하거나 색상 및 질감과 같은 수작업으로 만든 피처를 사용하여 이미지 영역을 설명한 다음 분류기를 사용하여 이러한 영역을 식별했습니다. 하지만 이러한 접근 방식은 다양한 자연 장면에서 제대로 작동하지 않았습니다. 현재의 최신 방법은 예를 들어 컨볼루션 신경망을 사용하여 그림자 가장자리를 학습하고 방향, 반복적 주의, 산만함 등의 요소를 고려한 주의 모듈을 설계합니다.

### 3 Proposed Methods

이미지에서 그림자를 제거하기 위해 제안된 방법인 이중 계층적 집계 네트워크(DHAN)를 소개합니다.

![제안된 Dual Hierarchical Aggregation Network의 네트워크 구조](Towards%20Ghost-free%20Shadow%20Removal%20via%20Dual%20Hierarc%20060762920b504ff8ba4d65eccee67e00/Untitled%201.png)

제안된 Dual Hierarchical Aggregation Network의 네트워크 구조

이 방법은 이미지 처리를 위한 컨텍스트 집계 네트워크(CAN)를 기반으로 하며 사전 학습된 VGG19 모델을 사용하여 하이퍼컬럼 특징을 추출합니다. 원본 RGB 이미지는 증강 네트워크 입력으로 사용됩니다. 다중 컨텍스트 피처는 확장 속도가 증가하는 여러 개의 확장 컨볼루션을 사용하여 인코딩됩니다. 각 컨볼루션 블록은 인스턴스 노멀라이제이션과 LeakyReLU 레이어를 따릅니다.

이 방법에는 그림자를 학습하고 저수준 디테일을 보존하기 위해 특별히 설계된 이중 계층적 집계가 포함됩니다. 이전 여러 레이어의 특징을 계층적 스타일로 집계하여 구축된 주의 모듈이 특징입니다. 네트워크는 더욱 풍부한 컨텍스트 주의를 위해 트리와 같은 구조로 피처를 병합합니다. 또한 관심 집계 노드, 피처 연결, 피처 레이어를 사용합니다.

![특징 집계와 주의 집계를 위한 Attentive Aggregation 노드.](Towards%20Ghost-free%20Shadow%20Removal%20via%20Dual%20Hierarc%20060762920b504ff8ba4d65eccee67e00/Untitled%202.png)

특징 집계와 주의 집계를 위한 Attentive Aggregation 노드.

집계된 각 피처는 다중 컨텍스트 주의에 따라 공간적으로 가중치가 재조정되며, 지상 실측 섀도 마스크는 주의에 대한 감독으로 사용됩니다. 각 집계 노드에서는 각 피처 채널의 중요도를 재가중하기 위해 스퀴즈 앤 여기 블록이 사용되며, 피처를 스퀴즈하고 원래 채널과 일치시키기 위해 3x3 컨볼루션이 추가됩니다. 다중 컨텍스트 피처 리믹싱을 위해 마지막 집계 블록의 끝에 공간 풀링 피라미드가 추가됩니다.

네트워크는 픽셀 및 특징 영역에서 다층 인식 손실을 사용하여 학습됩니다. 이 손실은 가중치가 있는 L1 손실을 사용하여 자연스러운 그림자 없는 이미지와 생성된 그림자 없는 이미지 간의 차이를 측정합니다. 예측 마스크와 기준선 마스크 사이의 이진 교차 엔트로피 손실로 계산되는 주의력 손실도 포함됩니다.

컨볼루션 신경망은 이미지의 그림자 테두리를 보존할 수 있으며, 이로 인해 그림자 제거 품질이 저하될 수 있습니다. 이 문제를 해결하기 위해 적대적 손실이 사용됩니다. 판별기는 생성된 이미지를 식별하고 생성기가 사실적인 그림자 없는 이미지를 생성하도록 최적화됩니다.

이 방법의 최종 목표는 GAN 손실, 다중 레이어 인식 손실, 주의력 손실 간의 균형을 맞추는 것입니다. 이 연구에서는 손실 가중치를 경험적으로 설정했습니다.

![Shadow Matting GAN의 네트워크 구조.](Towards%20Ghost-free%20Shadow%20Removal%20via%20Dual%20Hierarc%20060762920b504ff8ba4d65eccee67e00/Untitled%203.png)

Shadow Matting GAN의 네트워크 구조.

그림자 매팅 생성 적대 네트워크(SM-GAN)는 그림자/그림자가 없는 이미지 쌍으로 구성된 대규모 데이터 세트를 수집하는 데 따르는 문제를 해결하기 위해 도입되었습니다. 환경의 빛 변화와 다양한 그림자 마스크 및 장면으로 인해 이러한 이미지 쌍을 일관된 조건에서 캡처하는 것은 어렵습니다.

SM-GAN은 그림자가 없는 이미지와 무작위 마스크로부터 합성 그림자 이미지를 생성하여 이러한 문제를 해결하는 것을 목표로 합니다. 이 접근 방식을 사용하면 학습 데이터 세트를 확장하여 그림자 감지의 정확도를 개선하고 이러한 기술을 보다 자연스러운 영역으로 확장할 수 있습니다.

이 접근 방식은 제너레이터를 사용하여 해당 그림자가 없는 이미지와 마스크에서 그림자 이미지를 합성합니다. 그런 다음 판별기는 합성된 그림자 이미지가 진짜인지 아닌지를 식별하려고 시도합니다. 그림자 이미지를 직접 생성하는 방법과 달리 SM-GAN은 그림자 = 이미팅 × 무섀도라는 방정식에 따라 그림자 매팅을 학습합니다.

SM-GAN에서 생성기는 다중 스케일 지각 손실을 사용하여 예측 품질과 적대적 손실을 측정하여 출력의 사실성을 보장합니다. 생성된 그림자 이미지가 실제인지 아닌지를 식별하기 위해 판별기가 업데이트됩니다.

SM-GAN의 생성기는 CycleGAN과 유사하며, 판별기는 ReLU 비선형 활성화와 배치 정규화 레이어가 있는 5개의 컨볼루션 레이어로 구성됩니다. 이는 앞서 설명한 그림자 제거 네트워크와 유사합니다.

훈련 후에는 생성기를 사용하여 기존 데이터 세트의 그림자가 없는 이미지와 그림자 마스크를 사용하여 새로운 도메인 예제를 생성할 수 있습니다. 그런 다음 생성된 이미지를 사용하여 추가 학습을 위해 데이터 세트를 보강할 수 있습니다. 실험 결과, 이 접근 방식은 그림자 제거 및 감지 작업에 충분한 것으로 입증되었습니다.

### 4 Experiments

이 섹션에서는 그림자 매팅 생성적 적대 신경망(SM-GAN)을 평가하기 위해 수행한 실험 결과에 대해 설명합니다. 이 기술은 무작위 그림자 마스크와 그림자가 없는 이미지에서 그림자 이미지를 합성하여 그림자 네트워크의 정확도를 높이고 보다 다양한 자연 영역에 적용하는 것을 목표로 합니다. 이 실험에서는 새로운 학습 기반 그림자 제거 알고리즘인 이중 계층적 집계 네트워크(DHAN)도 테스트합니다.

![그림자 제거 비교. 상단과 하단의 두 샘플은 각각 ISTD와 SRD 데이터셋에서 가져온 것입니다. (d)에서 상단과 하단 두 결과는 각각 ST-CGAN (ST)과 DeShadowNet (DS)에서 가져온 것입니다. 확대해서 보기를 권장합니다.](Towards%20Ghost-free%20Shadow%20Removal%20via%20Dual%20Hierarc%20060762920b504ff8ba4d65eccee67e00/Untitled%204.png)

그림자 제거 비교. 상단과 하단의 두 샘플은 각각 ISTD와 SRD 데이터셋에서 가져온 것입니다. (d)에서 상단과 하단 두 결과는 각각 ST-CGAN (ST)과 DeShadowNet (DS)에서 가져온 것입니다. 확대해서 보기를 권장합니다.

그림자 제거 실험에는 표준 벤치마크인 ISTD(조명 인식 그림자 제거 및 전송 데이터 세트)와 SRD(그림자 제거 데이터 세트)가 사용되었습니다. 실험 결과, 주의 모델과 주의 손실의 효과로 인해 DHAN이 특히 그림자 영역에서 다른 방법보다 성능이 뛰어난 것으로 나타났습니다.

![SBU 데이터셋에서 최신 기술 방법과의 그림자 탐지 결과 비교.](Towards%20Ghost-free%20Shadow%20Removal%20via%20Dual%20Hierarc%20060762920b504ff8ba4d65eccee67e00/Untitled%205.png)

SBU 데이터셋에서 최신 기술 방법과의 그림자 탐지 결과 비교.

데이터 증강을 위한 새로운 도메인 예제를 생성하기 위해 SM-GAN 생성기를 사용했습니다. 이는 그림자 제거 및 탐지 작업에 유용한 것으로 나타났습니다. 그 결과 SM-GAN은 그림자 경계, 색상 불일치, 장면 이해도 등의 측면에서 어려움을 겪는 다른 모델보다 뛰어난 성능을 보였습니다.

제거 연구는 SRD 데이터 세트에 대한 네트워크 구조의 기여도를 평가했습니다. 그 결과 계층적 혼합 특징이 네트워크가 여러 컨텍스트를 더 잘 이해하고 로컬 게이트 컨볼루션은 정량적으로 덜 효과적이라는 것이 입증되었습니다.

![네트워크 구조에 대한 Ablation study. 노란색 영역에서 입력값과 함께 전체 방법의 결과를 표시합니다. 기준 네트워크 CAN은 그림자를 제거할 수 있지만 여전히 색상 불일치가 있고, 우리의 특징 LA(+LA)와 dual LA(+DLA)는 추가로 아티팩트를 제거할 수 있습니다](Towards%20Ghost-free%20Shadow%20Removal%20via%20Dual%20Hierarc%20060762920b504ff8ba4d65eccee67e00/Untitled%206.png)

네트워크 구조에 대한 Ablation study. 노란색 영역에서 입력값과 함께 전체 방법의 결과를 표시합니다. 기준 네트워크 CAN은 그림자를 제거할 수 있지만 여전히 색상 불일치가 있고, 우리의 특징 LA(+LA)와 dual LA(+DLA)는 추가로 아티팩트를 제거할 수 있습니다

그림자 합성 방법을 다른 딥러닝 기반 방법과 비교한 결과, 모든 지표에서 더 나은 성능을 보였습니다. 합성된 데이터 세트를 훈련에 사용하면 네트워크의 기능이 확장되어 새로운 장면에서 잠재력을 보여주었습니다.

![게이트 컨볼루션에서의 주의 비교. 결과와 해당 주의 맵을 보여줍니다. 명확하게 게이트 주의는 지역적으로 특징을 학습하는 반면, 우리의 주의는 성공적으로 그림자 영역을 예측합니다.](Towards%20Ghost-free%20Shadow%20Removal%20via%20Dual%20Hierarc%20060762920b504ff8ba4d65eccee67e00/Untitled%207.png)

게이트 컨볼루션에서의 주의 비교. 결과와 해당 주의 맵을 보여줍니다. 명확하게 게이트 주의는 지역적으로 특징을 학습하는 반면, 우리의 주의는 성공적으로 그림자 영역을 예측합니다.

실험 결과, SM-GAN과 DHAN은 각각 그림자 합성과 그림자 제거 작업에서 높은 성능을 달성했습니다. 이 방법은 그림자 경계와 색상 일관성을 개선하는 데 효과적이었으며 다른 최신 방법보다 성능이 뛰어났습니다.

![우리가 합성한 데이터셋 (ISTD+S)을 사용하여 훈련시키면 네트워크가 새로운 도메인에서 더 잘 작동하는 데 도움이 됩니다.](Towards%20Ghost-free%20Shadow%20Removal%20via%20Dual%20Hierarc%20060762920b504ff8ba4d65eccee67e00/Untitled%208.png)

우리가 합성한 데이터셋 (ISTD+S)을 사용하여 훈련시키면 네트워크가 새로운 도메인에서 더 잘 작동하는 데 도움이 됩니다.

### 5 Conclusion

이 논문에서는 두 가지 측면에서 고스트 없는 그림자 제거를 위한 방법을 제시합니다. 먼저 컨텍스트 집계 네트워크로 시작하여 피처와 어텐션을 계층적으로 집계하는 새로운 네트워크가 제안됩니다. 이 네트워크는 다중 컨텍스트 피처와 어텐션에서 경계가 없는 고품질 결과를 생성할 수 있습니다.

둘째, 섀도 매팅 생성적 적대 신경망(GAN)은 해당 섀도 프리 이미지와 마스크에서 섀도 이미지를 합성하도록 훈련됩니다. 이 GAN은 현재 그림자 제거 데이터 세트의 다양한 장면을 확장하고 색상 불일치를 줄이는 데 도움이 됩니다.

실험 결과에 따르면 두 가지 방법 모두 고스트가 없고 그림자가 없는 이미지를 생성하는 데 크게 기여하여 디지털 이미지의 그림자 제거 문제에 대한 강력한 접근 방식을 제공합니다.