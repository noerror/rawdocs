# DepthFM: Fast Monocular Depth Estimation with Flow Matching

[https://arxiv.org/abs/2403.13788](https://arxiv.org/abs/2403.13788)

- Mar 2024

## 1 Introduction

컴퓨터 비전의 주요 목표 중 하나가 2D 이미지만을 사용하여 우리의 3D 환경, 특히 장면의 깊이와 표면 방향을 이해하는 것임을 소개합니다. 이러한 이해는 컴퓨터 비전 태스크의 기본이며, 로보틱스와 자율 주행과 같은 다양한 응용 분야에 중요합니다. 그러나, 단일 이미지에서 실제적인 지오메트리를 추정하는 것은 여전히 어려운 문제입니다. 최신 깊이 추정 모델은 전반적으로 인상적인 성능을 보이지만, 훈련 과정에서 평균화 경향 때문에 세부적인 디테일과 날카로운 가장자리를 재현하는 데 한계가 있습니다.

이러한 문제를 해결하기 위해, 저자들은 데이터 의존적 결합을 사용하여 훈련과 추론의 효율성을 향상시킨 새로운 모델인 DepthFM을 제안합니다. 이 모델은 입력 이미지와 깊이 사이의 직접적인 관계를 설정하여, 기존의 확산 모델과 다른 접근 방식을 취합니다. 또한, 합성 데이터에만 교육함으로써 실제 이미지에 대해 강력한 일반화 능력을 달성합니다. 저자들은 이러한 방식으로, 기존 확산 모델에서 강력한 이미지 사전을 흐름 매칭 모델로 성공적으로 전달할 수 있다고 주장합니다.

이 장에서는 DepthFM 모델이 기존의 깊이 추정 작업뿐만 아니라 깊이 채우기 및 깊이 조건부 이미지 합성과 같은 하류 작업에서도 최첨단 성능을 보인다는 점을 강조합니다. 이 모델은 훈련 데이터에 대한 의존도를 최소화하면서도 정확도와 신뢰성을 유지하는 것을 목표로 합니다.

## 2 Related Works

### **깊이 추정**

깊이 추정은 컴퓨터 비전에서 흔히 접하는 과제로, 일반적으로 구분적(discriminative) 방식과 생성적(generative) 방식으로 접근됩니다. 구분적 깊이 추정은 실제 깊이(metric depth) 추정과 상대 깊이(relative depth) 추정으로 further categorized됩니다. 실제 깊이 추정에서는 깊이 간격을 이산화하고 연속적인 깊이 회귀 문제를 분류 문제로 재구성하는 접근법이 일반적입니다.

생성적 모델에서는 특히 확산 모델이 깊이 추정을 위해 활용됩니다. 이들 모델은 높은 품질의 깊이 추정치를 제공하지만, 확산 과정에 필요한 스토캐스틱 미분 방정식(SDE)을 해결하는 데 많은 시간이 소요됩니다. 이러한 방법은 가우스 분포에서 시작하여 깊이 맵으로 변환하는 과정을 포함하지만, 이미지와 깊이 맵 사이의 자연스러운 상관관계와 항상 일치하지는 않습니다. 반면, 흐름 매칭 모델은 다양한 작업에서 빠른 샘플링 속도를 제공하며, 특히 이미지와 깊이 맵 사이의 분포 이동을 용이하게 합니다.

### **확산 및 흐름 매칭 모델**

확산 모델은 이미지 생성과 같은 다양한 작업에서 뛰어난 성능을 보여주며, 조건부 생성, 이미지 대 이미지 번역, 텍스트 대 이미지 합성 등에 적용되었습니다. 또한, 이들은 이미지 개선, 파노픽 분할, 깊이 추정과 같은 구분적 작업에도 사용되었습니다. 흐름 기반 방법, 특히 흐름 매칭은 이미지 생성, 비디오 예측, 인간 모션 생성, 포인트 클라우드 생성 등 다양한 도메인에서 탐색되었습니다. 그러나 저자들은 이미지와 깊이 맵 사이의 분포 이동을 용이하게 할 수 있는 흐름 매칭을 활용하는 것이 직관적으로 확산 모델보다 더 유리하다고 지적합니다.

이 장에서는 깊이 추정 분야에서의 기존 연구와 확산 및 흐름 매칭 모델의 현재까지의 적용 사례를 소개하며, 이러한 기술들의 한계와 가능성을 탐구합니다. 저자들은 흐름 매칭 모델이 단안 깊이 추정 과제에 특히 적합할 수 있음을 시사하며, 이러한 모델을 활용한 새로운 접근법을 제안합니다.

## 3 Method

### **흐름 매칭 모델**

흐름 매칭(Flow Matching, FM) 모델은 고정된 조건부 확률 경로를 기반으로 벡터 필드를 회귀하는 생성 모델의 한 분류입니다. 이 모델은 데이터 공간 내의 데이터 포인트를 시간에 따라 변화하는 벡터 필드를 통해 정의된 미분 방정식의 해로 취급합니다. FM 모델은 입력 이미지와 그에 대응하는 깊이를 직접 연결하는 방식으로, 확산 모델과 달리 노이즈에서 시작하지 않고 입력 이미지로부터 깊이를 직접 생성합니다.

### **데이터 의존적 흐름 매칭**

저자들은 이미지와 깊이 쌍에 내재된 관계를 모델링하기 위해 데이터 의존적 결합을 사용합니다. 이 접근 방식은 이미지와 깊이 간의 직접적인 관계를 설정하여, 최소 분산을 통해 데이터 샘플 주변을 평활화함으로써 해당 데이터 분포를 얻습니다. 이를 통해 이미지에서 깊이로의 변환을 위한 동적 최적 전송 문제를 해결하며, 이는 보다 안정적이고 빠른 훈련을 가능하게 합니다.

### **잠재 공간 흐름 매칭**

고해상도 깊이 추정 합성의 계산 요구를 줄이기 위해, 저자들은 이미지 픽셀 공간과 지각적으로 일치하는 압축된 잠재 공간을 제공하는 오토인코더 모델을 사용합니다. 이 접근법은 이미지, 깊이, 표면 정상 등 모든 모달리티를 잠재 공간으로 이동시키며, 이미지 생성을 위한 기존의 확산 모델로부터 강력한 모델 사전을 직접 상속합니다.

### **노이즈 증강 및 SD 모델에서 FM 모델로의 파인튜닝**

노이즈 증강은 생성 모델의 성능을 향상시키는 데 사용되는 기술로, 저자들은 노이즈 증강을 통해 모델 성능을 개선합니다. 또한, 확산 모델로부터 흐름 매칭 모델로 직접 파인튜닝을 수행하여, 적은 양의 훈련으로 좋은 성능을 달성합니다.

### **깊이 정규화 및 표면 정상 손실**

저자들은 깊이 이미지를 RGB 이미지처럼 취급하여 세 채널로 변환하고, 데이터 범위가 모델 성능에 중요함을 발견합니다. 또한, 깊이 예측에서 파생된 표면 정상 필드와 실제 표면 정상 필드를 비교하여 보조 표면 정상 손실을 도입합니다. 이를 통해 깊이 예측의 정확도를 높이고 양적 성능을 개선합니다.

### **최종 손실**

최종 훈련 손실은 데이터 의존적 흐름 매칭 목표와 표면 정상 손실의 조합으로 정의됩니다. 이 손실 함수는 모델이 더 정확한 깊이 추정치를 생성하도록 유도하며, 깊이 추정의 정밀도와 신뢰도를 동시에 향상시키는 데 목적이 있습니다. 표면 정상 손실은 깊이 추정치에서 파생된 표면 정상과 실제 표면 정상 사이의 거리를 최소화함으로써, 모델이 보다 정확한 3D 형상 정보를 학습하도록 돕습니다. 이는 특히 가장자리와 같이 깊이 변화가 큰 지역에서 모델의 성능을 개선하는 데 도움이 됩니다.

### **훈련 및 평가**

DepthFM 모델의 훈련에는 합성 데이터 세트가 사용됩니다. 이는 실제 이미지에 대한 모델의 일반화 능력을 테스트하는 동시에, 모델이 실제와 유사한 깊이 정보를 학습할 수 있도록 합니다. 저자들은 또한 모델이 다양한 해상도와 종횡비를 가진 실제 이미지에 잘 일반화될 수 있음을 보여주기 위해, 고정된 해상도로 훈련된 모델이 다양한 해상도의 이미지에 대해 실제적인 깊이 맵을 생성할 수 있음을 실험을 통해 확인합니다.

### **실제 적용 사례**

DepthFM 모델은 단순히 깊이 추정에만 국한되지 않고, 깊이 보완(depth completion)과 같은 관련 작업에서도 뛰어난 성능을 보입니다. 깊이 보완은 부분적으로만 제공되는 깊이 정보를 가지고 전체 깊이 맵을 복원하는 작업으로, DepthFM 모델은 이러한 작업에 필요한 높은 정밀도와 일반화 능력을 제공합니다. 또한, 모델은 여러 샘플링을 통해 예측의 불확실성을 평가하는 능력을 가지고 있어, 깊이 예측의 신뢰도를 측정할 수 있습니다.

### **결론**

3장에서 저자들은 DepthFM, 새로운 흐름 매칭 기반의 단안 깊이 추정 모델을 상세히 소개하고, 이 모델이 기존의 확산 모델과는 다른 접근 방식을 취함으로써 더 빠르고 정확한 깊이 추정을 가능하게 한다고 주장합니다. 데이터 의존적 결합, 잠재 공간 흐름 매칭, 노이즈 증강, 그리고 SD 모델에서 FM 모델로의 파인튜닝과 같은 기술들은 모델의 훈련과 성능을 최적화하는 데 중요한 역할을 합니다. 이러한 방법론은 깊이 추정뿐만 아니라 다양한 컴퓨터 비전 작업에 적용될 수 있는 잠재력을 가지고 있음을 시사합니다.

## 4 Experiments

### **데이터셋 및 메트릭**

모델 훈련에는 Hypersim과 Virtual KITTI와 같은 합성 데이터셋이 사용되었습니다. 실제 세계 데이터셋인 NYUv2, KITTI, DIODE에서 제로샷(zero-shot) 평가를 통해 모델의 일반화 능력을 검증했습니다. 평가 메트릭으로는 절대 평균 상대 오차(Absolute Mean Relative Error, RelAbs)와 δ1 정확도가 사용되었습니다. 이 메트릭들은 모델이 예측한 깊이와 실제 깊이 간의 차이를 정량적으로 측정합니다.

### **제로샷 깊이 추정**

DepthFM 모델은 순수하게 합성 샘플 63k개만을 사용하여 훈련되었음에도 불구하고, 실내 및 실외 데이터셋에 대한 제로샷 깊이 추정에서 뛰어난 일반화 능력을 보였습니다. 이는 기존의 생성 모델과 비교하여 모델이 얼마나 적은 양의 데이터로도 강력한 성능을 낼 수 있는지를 보여줍니다.

### **생성 모델과의 비교**

DepthFM은 Marigold와 같은 대표적인 확산 기반 생성 모델과 비교되었습니다. 이 비교는 DepthFM이 단일 함수 평가에서도 Marigold가 4번의 함수 평가를 필요로 하는 경우보다 우수한 성능을 보임을 확인시켜 줍니다. 이는 흐름 매칭 모델의 효율성과 빠른 처리 속도를 강조합니다.

### **판별 모델과의 비교**

DepthFM 모델은 또한 객체 가장자리에서의 흐릿한 라인 문제를 해결하여, 3D 왜곡과 같은 하류 태스크에 있어 모델의 견고함을 개선합니다. 이러한 성능 향상은 생성 모델의 확률론적 특성으로부터 비롯된 것으로, 모델이 깊이 예측의 불확실성을 정량화할 수 있게 합니다.

### **해상도 간 일반화**

모델이 다양한 해상도와 종횡비를 가진 실제 데이터에 잘 일반화되는 것을 보여주는 실험도 수행되었습니다. 이는 모델이 고정된 해상도의 합성 데이터로 훈련되었음에도 불구하고, 다양한 실제 조건에서도 신뢰할 수 있는 깊이 맵을 생성할 수 있음을 시사합니다.

### **깊이 보완**

깊이 센서의 하드웨어적 한계로 인해 부분적인 깊이 이미지만 사용할 수 있는 깊이 보완 태스크에 대한 모델의 성능도 평가되었습니다. DepthFM 모델은 최소한의 파인튜닝으로 NYU-v2 데이터셋에서 최첨단 성능을 달성하며, 이는 모델의 유연성과 적응성을 보여줍니다.

### **불확실성 추정**

생성 모델의 능력을 활용하여 여러 번의 조건부 샘플링을 통해 모델의 예측에 대한 불확실성, 즉 미조정된 불확실성을 평가할 수 있습니다. 저자들은 n개의 앙상블 멤버에 대한 예측의 표준 편차를 계산함으로써 불확실성을 추정합니다. 높은 표준 편차는 모델의 예측이 더 불확실하고 우리 모델의 확률론적 특성에 더 민감함을 의미합니다. 이러한 방법을 통해, 특히 깊이 변화가 큰 영역에서 모델의 예측에 대한 신뢰도를 평가할 수 있습니다.

### **Ablation Study**

저자들은 또한 시작 분포와 보조 표면 정상 손실에 대한 ablation study를 수행했습니다. 이 연구는 모델의 다양한 구성요소가 전체 성능에 미치는 영향을 평가하기 위함입니다. 예를 들어, 모델을 이미지로부터 시작하는 것과 가우시안 노이즈에서 시작하는 것 사이의 차이를 비교하여, 이미지로부터 시작하는 방식이 모델의 훈련 효율성과 성능을 향상시킨다는 것을 발견했습니다. 또한, 표면 정상 손실을 추가하는 것이 모델이 더 정확한 깊이 추정치를 생성하는 데 도움이 됨을 확인했습니다.

### **결론 및 미래 연구 방향**

DepthFM 모델은 광범위한 실험을 통해 단안 깊이 추정, 깊이 보완, 그리고 다양한 해상도의 이미지에 대한 일반화 능력에서 우수한 성능을 보였습니다. 이 모델은 합성 데이터에만 기반하여 훈련되었음에도 불구하고, 실제 세계의 이미지에 대해 강력한 일반화 능력을 보여주며, 생성적 접근 방식의 장점을 활용하여 예측의 불확실성을 평가할 수 있습니다. 이 연구는 단안 깊이 추정 분야에서 중요한 진보를 나타내며, 향후 이 분야의 연구에 중요한 기여를 할 것으로 기대됩니다. 저자들은 향후 연구에서 이 모델을 다른 컴퓨터 비전 태스크에 적용하거나, 모델의 효율성과 정확도를 더욱 향상시킬 수 있는 방법을 탐색할 것을 제안합니다.

## 5 Conclusion

### **모델의 혁신과 기여**

저자들은 DepthFM, 새로운 흐름 매칭 기반의 단안 깊이 추정 모델을 제안하고, 이 모델이 기존 확산 기반 솔루션보다 상당히 효율적인 동시에 세밀한 깊이 맵을 제공한다는 점을 강조합니다. 이 모델은 단순히 노이즈 분포에서 깊이 맵으로의 변환을 시도하는 대신, 입력 이미지와 깊이 사이의 직접적인 매핑을 학습하여, 고전적인 차별화 패러다임의 일반적인 아티팩트 없이 더 정밀한 깊이 정보를 생성합니다.

### **합성 데이터의 효과적 활용**

DepthFM은 전적으로 합성 데이터에 기반하여 훈련되었음에도 불구하고, 실제 이미지에서도 뛰어난 일반화 능력을 보여줍니다. 이는 모델이 합성 데이터에서 얻은 지식을 효과적으로 실제 세계의 시나리오로 전이할 수 있음을 의미합니다. 또한, 보조 표면 정상 손실을 사용함으로써 깊이 추정의 정확성을 향상시키는 방법을 제시합니다.

### **모델의 실용성과 신뢰도**

DepthFM 모델은 경량이면서도 빠르고, 신뢰할 수 있는 깊이 예측을 제공합니다. 이는 자율 주행, 로보틱스, 증강 현실과 같은 실시간 응용 프로그램에서의 사용 가능성을 시사합니다. 특히, 모델이 제공하는 불확실성 추정은 실세계 응용에서 중요한 정보를 제공할 수 있습니다.

### **향후 연구 방향**

저자들은 이 연구가 단안 깊이 추정 분야에 중요한 기여를 하였으며, 향후 연구에서 이 모델을 기반으로 더욱 발전시킬 수 있는 가능성을 제시합니다. 예를 들어, 모델의 정확도와 효율성을 더욱 향상시키거나, 다른 컴퓨터 비전 태스크에 DepthFM을 적용하는 것 등이 연구될 수 있습니다.

### **결론**

결론적으로, DepthFM은 단안 깊이 추정을 위한 강력하고 혁신적인 모델로서, 뛰어난 성능과 실용성을 제공합니다. 이 연구는 깊이 추정 분야에 새로운 방향을 제시하며, 향후 다양한 응용 분야에서 이 모델의 활용을 기대하게 만듭니다.