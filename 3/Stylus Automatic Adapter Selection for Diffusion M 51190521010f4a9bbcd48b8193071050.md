# Stylus: Automatic Adapter Selection for Diffusion Models

[https://arxiv.org/abs/2404.18928](https://arxiv.org/abs/2404.18928)

- Apr 2024

![어댑터 선택. 사용자가 제공한 프롬프트를 기반으로, 우리의 방법은 프롬프트의 맥락과 키워드 중 최소 하나와 밀접하게 연관된 고도로 관련성 높은 어댑터(예: Low-Rank Adaptation, LoRA)를 식별합니다. 관련 어댑터를 Stable Diffusion에 통합함으로써 시각적 충실도, 이미지 다양성 및 텍스트 정렬이 향상됩니다. 이 프롬프트들은 MS-COCO에서 샘플링되었습니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled.png)

어댑터 선택. 사용자가 제공한 프롬프트를 기반으로, 우리의 방법은 프롬프트의 맥락과 키워드 중 최소 하나와 밀접하게 연관된 고도로 관련성 높은 어댑터(예: Low-Rank Adaptation, LoRA)를 식별합니다. 관련 어댑터를 Stable Diffusion에 통합함으로써 시각적 충실도, 이미지 다양성 및 텍스트 정렬이 향상됩니다. 이 프롬프트들은 MS-COCO에서 샘플링되었습니다.

## 1. Introduction

이 연구는 생성 이미지 모델 분야에서 미세 조정 어댑터의 표준화와 그 영향을 다룹니다. 특히, Low-Rank Adaptation (LoRA)이 주요 미세 조정 방법으로 부상하면서, 이러한 어댑터들을 활용하여 고품질의 이미지를 생성하는 새로운 패러다임이 등장했습니다. 사용자들은 기존의 체크포인트 위에 다양한 어댑터를 수동으로 선택하고 조합하여 이미지를 생성하게 되는데, 이는 모델의 클래스나 스케일을 향상시키는 기존 방식을 넘어선 것입니다.

![Stylus 알고리즘. Stylus는 세 단계로 구성됩니다. 정제자는 어댑터의 모델 카드를 비전-언어 모델(VLM)을 통해 연결하고 어댑터의 작업에 대한 텍스트 설명을 생성한 다음, 해당 텍스트 임베딩을 생성하기 위해 인코더를 사용합니다. 검색기는 사용자 프롬프트 전체와 관련된 후보 어댑터를 가져옵니다. 마지막으로, 구성자는 남은 어댑터를 프롬프트의 작업과 관련된 키워드 세트에 따라 다듬고 공동으로 분류합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%201.png)

Stylus 알고리즘. Stylus는 세 단계로 구성됩니다. 정제자는 어댑터의 모델 카드를 비전-언어 모델(VLM)을 통해 연결하고 어댑터의 작업에 대한 텍스트 설명을 생성한 다음, 해당 텍스트 임베딩을 생성하기 위해 인코더를 사용합니다. 검색기는 사용자 프롬프트 전체와 관련된 후보 어댑터를 가져옵니다. 마지막으로, 구성자는 남은 어댑터를 프롬프트의 작업과 관련된 키워드 세트에 따라 다듬고 공동으로 분류합니다.

이 연구는 어댑터를 자동으로 선택하는 방식을 탐구합니다. 기존의 검색 기반 시스템과는 달리, 적절한 어댑터를 선택하는 것은 고품질 문서화의 부재나 훈련 데이터에 직접적인 접근이 불가능할 때 더욱 복잡해집니다. 또한, 사용자 프롬프트는 종종 여러 구체적인 작업을 함축하고 있어, 이를 효과적으로 세분화하여 각 작업에 맞는 어댑터를 선택해야 합니다.

![어댑터 수. Civit AI는 Stable Diffusion을 위해 100K 이상의 어댑터를 자랑하며, Hugging Face보다 앞서 있습니다. Low-Rank Adaptation (LoRA)은 미세 조정에 있어서 지배적인 접근법입니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%202.png)

어댑터 수. Civit AI는 Stable Diffusion을 위해 100K 이상의 어댑터를 자랑하며, Hugging Face보다 앞서 있습니다. Low-Rank Adaptation (LoRA)은 미세 조정에 있어서 지배적인 접근법입니다.

이러한 배경에서 'Stylus'라는 시스템을 제안하여, 사용자 프롬프트를 효율적으로 평가하고 관련성 높은 어댑터 집합을 검색 및 구성하여 다양하고 고품질의 이미지를 자동으로 생성할 수 있도록 합니다. Stylus는 어댑터의 텍스트 설명을 임베딩으로 변환하고, 이를 사용하여 사용자 프롬프트와의 연관성을 평가합니다. 여러 어댑터를 조합할 때 발생할 수 있는 이미지 품질 저하, 기존 개념의 덮어쓰기, 원치 않는 편향의 도입과 같은 문제들을 효과적으로 관리합니다.

## 2. Related Works

이 챕터에서는 어댑터와 검색 기반 방법에 대해 주로 다룹니다.

- **어댑터**: 어댑터는 특정 작업에 대해 모델을 효율적으로 미세 조정할 수 있도록 설계되었습니다. 어댑터는 모델을 미세 조정하는 동안 최소한의 매개변수 변경으로 계산 및 저장 공간 요구 사항을 줄이면서 유사한 성능을 유지합니다. 특히, Low-Rank Adaptation(LoRA)은 오픈소스 커뮤니티에서 인기 있는 접근법으로 자리 잡았습니다. 이미지 도메인에서는 다양한 어댑터들을 결합하여, 사용자 요구 사항에 부합하는 고품질의 이미지를 생성할 수 있습니다. 이 연구에서는 사용자 프롬프트를 명확한 작업으로 세분화하고 적절한 어댑터를 결합하는 방식을 발전시키고자 합니다.
- **검색 기반 방법**: 검색 기반 생성(Retrieval-Augmented Generation, RAG)과 같은 방법은 모델 응답을 향상시키기 위해 의미론적으로 유사한 텍스트를 대규모 외부 데이터베이스에서 추가합니다. 이러한 방법은 텍스트를 벡터 임베딩으로 변환하고, 사용자 프롬프트와의 유사성에 따라 순위를 매깁니다. 본 연구는 RAG에서 영감을 받아 어댑터를 벡터 임베딩으로 인코딩하고, 이를 시각-언어 기초 모델을 사용하여 의미론적 설명을 생성하여 번역합니다. 하지만 RAG의 한계는 정밀도가 제한적이며, 관련성이 낮은 문서를 검색해내는 문제가 있습니다. 최근 연구에서는 이러한 문제를 해결하기 위해 개별 사용자 프롬프트와 순위가 매겨진 원시 텍스트 집합을 개별적으로 평가하는 교차 인코더를 사용하는 재순위 매김 단계를 도입했습니다.

이 챕터는 어댑터의 효율적인 사용과 향상된 검색 기반 방법을 통해 기존의 기반 모델의 기능을 증강하는 다양한 접근법들을 탐구하고, 이를 발전시키는 데 기여합니다.

## 3. Our Method: Stylus

이 챕터는 Stylus, 새로운 어댑터 선택 및 조합 시스템을 소개하고 그 세부적인 작업 방법을 설명합니다. Stylus는 기존의 텍스트 검색 방법과 다른 도전을 극복하기 위해 세 단계 프레임워크를 사용합니다.

![Stylus와 실제적 스타일(왼쪽) 및 만화 스타일(오른쪽) Stable Diffusion 체크포인트 간의 질적 비교. Stylus는 프롬프트의 맥락에 맞는 키워드를 정확하게 묘사한 매우 상세한 이미지를 생성합니다. 예를 들어, "벽에 코기 그래피티"라는 프롬프트에 대해 우리의 방법은 스프레이로 칠한 코기를 정확하게 묘사하는 반면, 체크포인트는 실제 개를 생성합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%203.png)

Stylus와 실제적 스타일(왼쪽) 및 만화 스타일(오른쪽) Stable Diffusion 체크포인트 간의 질적 비교. Stylus는 프롬프트의 맥락에 맞는 키워드를 정확하게 묘사한 매우 상세한 이미지를 생성합니다. 예를 들어, "벽에 코기 그래피티"라는 프롬프트에 대해 우리의 방법은 스프레이로 칠한 코기를 정확하게 묘사하는 반면, 체크포인트는 실제 개를 생성합니다.

![인간 평가. 다양한 데이터셋과 Stable Diffusion 체크포인트에 대해 Stylus는 더 높은 선호도 점수(2:1)를 달성합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%204.png)

인간 평가. 다양한 데이터셋과 Stable Diffusion 체크포인트에 대해 Stylus는 더 높은 선호도 점수(2:1)를 달성합니다.

### **정제자(Refiner)**:

- 정제자는 두 단계 파이프라인으로, 어댑터의 작업과 해당하는 텍스트 임베딩을 생성합니다.
- 첫 번째 단계에서는 비전-언어 모델(VLM)을 사용하여 어댑터의 모델 카드(예시 이미지, 프롬프트, 저자 설명)로부터 개선된 설명을 도출합니다.
- 두 번째 단계에서는 임베딩 모델을 사용하여 모든 어댑터에 대한 임베딩을 생성하고 이를 벡터 데이터베이스에 저장합니다.

### **검색기(Retriever)**:

- 검색기는 사용자 프롬프트 전체에 대해 가장 관련성 높은 어댑터를 검색합니다.
- 이 과정에서는 임베딩 모델을 사용하여 사용자 프롬프트의 임베딩을 생성하고, 이를 어댑터의 임베딩과 비교하여 코사인 유사도 점수를 계산합니다.
- 유사도가 높은 상위 K개의 어댑터를 선택합니다.

### **구성자(Composer)**:

- 구성자는 프롬프트를 키워드 기반의 작업으로 세분화하고, 검색된 어댑터를 이러한 작업에 할당하는 역할을 합니다.
- 이 단계는 어댑터가 프롬프트의 의미와 일치하지 않거나 편향을 도입할 가능성이 있는 어댑터를 걸러냅니다.
- 구성자는 키워드를 기반으로 작업을 정의하고, 각 작업에 가장 적합한 어댑터 집합을 할당합니다.
- 이 프로세스는 또한 재순위화를 포함하는데, 이는 교차 인코더를 사용하여 검색된 어댑터 설명과 사용자 프롬프트 간의 더 나은 유사도 점수를 결정합니다.

Stylus는 이러한 세 단계를 통해 사용자 프롬프트에 맞는 최적의 어댑터 조합을 자동으로 선택하고 구성하여, 다양하고 고품질의 이미지를 생성할 수 있도록 합니다. 이 접근 방식은 기존 방법들이 직면한 여러 문제를 효과적으로 해결하며, 이미지 생성의 다양성과 품질을 향상시키는 것을 목표로 합니다.

## 4. Results

![ COCO의 Clip/FID Pareto 곡선. Stylus가 다양한 가이드 값(CFG): [1, 1.5, 2, 3, 4, 6, 9, 12] 범위에서 시각적 충실도(FID) 및/또는 텍스트 정렬(CLIP)을 향상시킬 수 있음을 관찰합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%205.png)

 COCO의 Clip/FID Pareto 곡선. Stylus가 다양한 가이드 값(CFG): [1, 1.5, 2, 3, 4, 6, 9, 12] 범위에서 시각적 충실도(FID) 및/또는 텍스트 정렬(CLIP)을 향상시킬 수 있음을 관찰합니다.

### **실험 설정(Experimental Setup)**:

- **어댑터 테스트베드(Adapter Testbed)**: Stylus의 성능을 평가하기 위해, 75K의 LoRA 어댑터를 포함하는 StylusDocs 데이터셋을 사용합니다. 이 데이터셋은 인기 있는 모델 저장소에서 어댑터를 수집하고, 이를 OpenAI의 임베딩과 개선된 어댑터 설명으로 채웁니다.
- **생성 세부 사항(Generation Details)**: Stylus는 StableDiffusion-v1.5을 기본 모델로 사용하며, Realistic-Vision-v6 및 Counterfeit-v3 체크포인트를 통해 실제적 및 만화/애니메이션 스타일의 이미지를 생성합니다. 고해상도 업스케일링을 통해 더 높은 품질의 이미지를 생성합니다.

### **주요 실험(Main Experiments)**:

- **인간 평가(Human Evaluation)**: Microsoft COCO와 PartiPrompts 데이터셋을 사용하여, 실제 및 애니메이션 스타일 이미지를 생성하고, 네 명의 사용자가 Stylus와 Stable Diffusion v1.5 생성 이미지를 비교 평가합니다. 평가 결과, 대체로 Stylus가 기존 모델보다 선호되었습니다.
- **자동 벤치마크(Automatic Benchmarks)**: CLIP과 FID를 사용하여 이미지의 텍스트 정렬과 다양성을 평가합니다. Stylus는 이 두 지표 모두에서 개선을 보여주며, 특히 COCO 2014 검증 데이터셋에서 효과가 두드러집니다.
- **VLM 평가(VLM as a Judge)**: VLM을 사용하여 텍스트 정렬과 시각적 충실도를 평가합니다. Stylus는 실제적인 이미지 스타일에서 높은 승률을 보이며, 대부분의 프롬프트에서 높은 일관성을 보여줍니다.

### **다양성 평가(Diversity per Prompt)**:

![이미지 다양성. 동일한 프롬프트에 대해, 우리의 방법(왼쪽)은 기존의 Stable Diffusion 체크포인트(오른쪽)보다 더 다양하고 포괄적인 이미지 세트를 생성합니다. Stylus의 다양성은 마스킹 스키마와 구성자 LLM의 온도에서 비롯됩니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%206.png)

이미지 다양성. 동일한 프롬프트에 대해, 우리의 방법(왼쪽)은 기존의 Stable Diffusion 체크포인트(오른쪽)보다 더 다양하고 포괄적인 이미지 세트를 생성합니다. Stylus의 다양성은 마스킹 스키마와 구성자 LLM의 온도에서 비롯됩니다.

- Stylus는 동일한 프롬프트에 대해 다양한 출력을 생성하는 능력을 보여줍니다. 이는 다양한 어댑터 조합과 마스킹 전략을 통해 달성됩니다.
- **dFID 지표**: 이 지표는 프롬프트별 다양성을 평가하기 위해 사용되며, InceptionV3의 잠재 임베딩의 분산을 계산하여 다양성을 측정합니다. Stylus는 이 지표에서도 높은 점수를 받아, 이미지의 다양성이 개선되었음을 입증합니다.
- **GPT-4V 평가**: GPT-4V를 사용하여 이미지 간의 다양성을 평가합니다. Stylus는 다양한 이미지 생성에서 높은 다양성 점수를 받으며, 이는 자동 평가에서도 성공적으로 다양성을 확보하고 있음을 나타냅니다.
    
    ![GPT-4V를 판사로 한 선호도 승률. Stylus는 시각적 품질과 이미지 다양성에 대해 GPT-4V를 통해 더 높은 선호도 점수를 달성합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%207.png)
    
    GPT-4V를 판사로 한 선호도 승률. Stylus는 시각적 품질과 이미지 다양성에 대해 GPT-4V를 통해 더 높은 선호도 점수를 달성합니다.
    
    ![프롬프트 길이에 따른 이미지 다양성(dFID). 프롬프트 길이가 증가함에 따라 Stylus는 Stable Diffusion보다 높은 다양성 점수를 달성합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%208.png)
    
    프롬프트 길이에 따른 이미지 다양성(dFID). 프롬프트 길이가 증가함에 따라 Stylus는 Stable Diffusion보다 높은 다양성 점수를 달성합니다.
    

### **부분 실험(Ablations)**:

- **대안적 검색 기반 방법**: Stylus의 성능을 다른 검색 기반 방법들과 비교합니다. 이들 중 Stylus는 가장 높은 CLIP 및 FID 점수를 얻으며, 기존의 Stable Diffusion 모델보다 우수한 성능을 보여줍니다.
    
    ![다른 검색 방법 비교. Stylus는 이미지에 외래 개념을 도입하거나 프롬프트의 다른 개념을 덮어쓰는 검색 방법을 모두 능가합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%209.png)
    
    다른 검색 방법 비교. Stylus는 이미지에 외래 개념을 도입하거나 프롬프트의 다른 개념을 덮어쓰는 검색 방법을 모두 능가합니다.
    
- **시스템 지연 시간 분석**: Stylus의 각 구성 요소가 이미지 생성 과정에 추가하는 지연 시간을 분석합니다. 특히, 구성자(Composer)가 상당한 오버헤드를 추가하지만, 배치 크기가 커짐에 따라 상대적 오버헤드는 감소합니다.
    
    ![배치 크기(BS)에 따른 Stylus의 추론 오버헤드와 Stable Diffusion의 추론 시간 비교. BS=1에서 Stylus는 이미지 생성 시간의 75%를 차지하며, 주로 어댑터 설명에서 긴 맥락의 프롬프트를 처리하는 구성자 때문입니다. 그러나 배치 크기가 증가함에 따라 Stylus의 오버헤드는 감소합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%2010.png)
    
    배치 크기(BS)에 따른 Stylus의 추론 오버헤드와 Stable Diffusion의 추론 시간 비교. BS=1에서 Stylus는 이미지 생성 시간의 75%를 차지하며, 주로 어댑터 설명에서 긴 맥락의 프롬프트를 처리하는 구성자 때문입니다. 그러나 배치 크기가 증가함에 따라 Stylus의 오버헤드는 감소합니다.
    

### **이미지 도메인 작업(Image-Domain Tasks)**:

- **이미지 변환(Image Translation)**: Stylus는 원본 이미지를 사용자 프롬프트에 정의된 스타일로 변환하는 데 효과적입니다. 예를 들어, 오토바이를 3D 비트로 분해하거나 자연 풍경에 화산 요소를 추가하는 등의 작업을 수행합니다.
    
    ![(a) 이미지 변환. Stylus는 기존 이미지에 새로운 스타일과 요소를 더 잘 적용할 수 있는 관련 어댑터를 선택합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%2011.png)
    
    (a) 이미지 변환. Stylus는 기존 이미지에 새로운 스타일과 요소를 더 잘 적용할 수 있는 관련 어댑터를 선택합니다.
    
- **이미지 인페인팅(Inpainting)**: Stylus는 이미지의 지정된 영역을 특정 캐릭터나 테마로 정확하게 채우는 능력을 보여줍니다. 이를 통해 시각적 충실도가 향상됩니다.
    
    ![(b) 인페인팅. Stylus는 인페인팅된 마스크에 새로운 캐릭터나 개념을 더 잘 도입할 수 있는 어댑터를 선택합니다.](Stylus%20Automatic%20Adapter%20Selection%20for%20Diffusion%20M%2051190521010f4a9bbcd48b8193071050/Untitled%2012.png)
    
    (b) 인페인팅. Stylus는 인페인팅된 마스크에 새로운 캐릭터나 개념을 더 잘 도입할 수 있는 어댑터를 선택합니다.
    

이 연구는 Stylus가 기존의 Stable Diffusion 체크포인트에 비해 시각적 충실도, 텍스트 정렬, 이미지 다양성을 개선하는 데 성공했음을 보여줍니다. 이 결과는 자동 메트릭, 인간 평가자, 그리고 비전-언어 모델을 통한 평가를 통해 입증되었습니다. Stylus는 이미지 생성 프로세스에 큰 부담을 추가하지 않으면서도 다양한 이미지 생성 도메인에서 확장 가능성을 보여주는 강력한 도구임을 증명했습니다.

## 5. Conclusion

이 논문의 결론 부분에서는 Stylus 시스템이 어댑터 선택과 조합을 자동화하여 고품질 이미지를 생성하는 새로운 방법론을 성공적으로 제시했다는 점을 강조합니다. Stylus는 특정 키워드를 기반으로 가장 관련성 높은 어댑터를 검색하고, 이를 통해 시각적 충실도, 텍스트 정렬, 이미지 다양성을 향상시킵니다.

논문은 Stylus 시스템의 세 단계 프레임워크—정제자(Refiner), 검색기(Retriever), 구성자(Composer)—가 기존의 Stable Diffusion 체크포인트보다 우수한 결과를 얻는다는 것을 다양한 평가 방법을 통해 입증합니다. 이러한 평가에는 자동 메트릭, 인간 평가자, 그리고 비전-언어 모델이 포함됩니다.

또한, Stylus는 이미지 생성 과정에 큰 부담을 추가하지 않으면서도 다양한 이미지 생성 도메인에 적용 가능함을 보여줍니다. 이는 이미지 변환과 인페인팅과 같은 다양한 이미지-대-이미지 작업에서의 활용 가능성을 포함합니다.

결론적으로, Stylus는 개선된 어댑터 데이터셋(StylusDocs)과 성능 평가 결과를 바탕으로, 생성 이미지 모델 분야에서의 새로운 표준을 제시하며, 이는 기술적 효율성과 창의적 표현의 확장에 기여할 것으로 기대됩니다.